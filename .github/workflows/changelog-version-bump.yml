name: Update Changelog and Version

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

jobs:
  update-changelog-and-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for changelog generation

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          # Verify installation
          which claude
          claude --version
          echo "Claude Code installed successfully"

      - name: Configure Claude API key
        run: |
          mkdir -p ~/.config/anthropic
          echo '{"api_key": "${{ secrets.ANTHROPIC_API_KEY }}"}' > ~/.config/anthropic/config.json
          echo "Configuration completed"
          
      - name: Test Claude CLI
        run: |
          # Test if Claude CLI works with a simple prompt
          echo "Testing Claude CLI..."
          claude -p "Say hello" || echo "Claude test failed with exit code $?"

      - name: Debug information
        run: |
          echo "Environment information:"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Python version: $(python --version)"
          echo "System info: $(uname -a)"
          echo "Working directory: $(pwd)"
          echo "API Key configured: $(test -f ~/.config/anthropic/config.json && echo 'Yes' || echo 'No')"
          echo "Files in directory:"
          ls -la

      - name: Simple Claude Test
        run: |
          # Plain text output to standard output
          claude -p "What is 2+2?" || echo "Exit code: $?"

      - name: Update Changelog
        run: |
          # Simplest possible command
          claude -p "Update the changelog based on recent git commits and increment the version in pyproject.toml. When done, print the new version number." \
            --allowedTools "Read" "Write" "Bash"
          
          # Check claude exit code
          CLAUDE_EXIT=$?
          echo "Claude exit code: $CLAUDE_EXIT"
          
          if [ $CLAUDE_EXIT -ne 0 ]; then
            echo "Claude failed to update changelog"
            exit 1
          fi

      - name: Commit Changes
        run: |
          # Check if any changes were made
          if ! git diff --quiet; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            
            # Extract new version from pyproject.toml
            NEW_VERSION=$(grep -o 'version = "[^"]*"' pyproject.toml | head -1 | cut -d'"' -f2)
            echo "New version from pyproject.toml: $NEW_VERSION"
            
            # Commit the changes
            git add CHANGELOG.md pyproject.toml src/__init__.py || true
            git commit -m "chore: Update changelog and bump version to $NEW_VERSION [skip ci]"
            git push
            
            # Create a version tag
            if [ -n "$NEW_VERSION" ]; then
              git tag v$NEW_VERSION
              git push origin v$NEW_VERSION
            fi
          else
            echo "No changes were made"
          fi